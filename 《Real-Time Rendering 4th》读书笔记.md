# 《Real-Time Rendering 4th》读书笔记
## Chapter 5. Shading Basics
当你渲染三维物体的图像时，模型应该不仅仅是具有适当的几何形状，也应具有所需的视觉外观。根据应用程序的不同，它的范围从光现实(一种外观)几乎与真实物体的照片一样，呈现出不同类型的风格化外观。
### 5.1 Shading Models
1. 确定渲染物体的围观的第一步是选择一种能描述物体颜色是如何受外界因素（比如表面方向，视角和光）的影响而变化的模型。渲染模型通常有一些属性能控制外观变化
2. 大多数的渲染模型通常是用表面朝向，视角和光线角度三因素来控制渲染外观。这三个角度都用normalized vector表示。

$$
C_{shaded} = sc_{highlight}+(1-s)(t  c_{warm}+(1-t)c_{cool})
$$
或
$$
lerp( lerp(c_{cool},c_{warm},t), c_{highlight}, s )
$$

- $c_{cool}=(0.0.0.55)+0.25c_{surface}$，
- $c_{warm}=(0.3,0.3,0)+0.25c_{surface}$，
- $c_{highlight}=(1,1,1)$：高光
- $t = \frac{(n \cdot l)+1}{2}$：值范围$[0.5,1]$，度量法线n与光线l的关系，夹角越小，t越大
- $r=2(n\cdot l)n-l$：计算光的反射向量（对应着色器语言的reflect函数），
- $s=(100  (r \cdot v)-97)^\mp$：光的反射线r与视线v的关系，夹角越小，s越大，其中"$\mp$"表示clamp(0,1)。

### 5.2 Lighting Source
$$
c_{shaded}=f_{unlit}(n,v)+\sum^n_{i=1}(l_i\cdot n)^+c_{light_i}f_{lit}(l_i,n,v)
$$
- $f_{lit}(l_i,v,n)$：这个参数，一个简单的选择是使它成为一个常量颜色，如$f_{lit()}=c_{surface}$(Lambert模型，该模型假设物体是一个很好的表面，它是一个很好的光扩散反射面)
  $$
  c_{shaded}=f_{unlit}(n,v)+\sum^n_{i=1}(l_i\cdot n)^+c_{light_i}c_{surface}
  $$
  
- $(l_i\cdot n)^+$:光的浓度，总是与夹角成cos关系（$l_i$和$n$均为法向量），$^+$clamp负数到0

- $f_{unlit}(n,v)$表示末受光影响时的颜色函数（比如环境光或其它二次反射的光和天空盒的光，比如unity里烘培的静态光）$x^+$表示clamp负数到0

- $c_{light}$：表示光的颜色(在点光源里$c_{light}$总是会随距离衰减)

  点光源来说$c_{light_i}$的衰减

$$
c_{light}(r)=c_{light_0}f_{dist}(r),
$$
$$
f_{dist}(r)=\frac{r_0^2}{r^2+e}f_{win}(r)
$$

$$
f_{win}(r)=(1-(\frac{r}{r_{max}})^4)^{+2}
$$

- $r_0$

- $f_{dist}(r)$：衰减函数（r为点光源位置到表面点的距离）

- e为了避免r接近于0时，r的平方无限趋近于0，由于浮点数精度导致分母为0

- $^{+2}$表示先将负数clamp到0，再平方（2次方）

- 为了性能，有些引擎可能不使用$\frac{1}{r^2}$这种方法，比如有些引擎使用这种方法：
  $$
  f_{dist}(r)=(1-(\frac{r}{r_{max}})^2)^{+2}
  $$
  

$f_{win}(r)$避免r很大时，


### Spotlights

### 5.3 Implementing Shading Models

实现一种光照模型的例子

![Sample](.\Imgs\bSbNxRh.png)

#### 5.3.3 Material Systems

(末读)

### 5.4 Aliasing and Antialiasing(走样与反走样)

- 采样定理：要正确地采样信号(即可以从样本中重建原始信号)，采样频率必须大于被采样信号最大频率的两倍。采样频率被称为奈奎斯特率（或奎斯特极限）

- 三位场景的点阵采样是不带限的，所以使用点阵采样渲染3D场景时走样是不可能避免的

  滤波器

  - box filter：盒式滤波器是一个分段常值函数
    $$
    a_{box},r[i]=
    \begin{cases}
    \frac{1}{(2r+1)}\quad\quad|i|\leq r\\
    0\quad\quad\quad\quad其它
    
    \end{cases}
    $$

  - tent filter，帐篷式滤波器

  - sinc filter，可以得到一个平滑的表现，去除信号里的突变

### 5.4.2 Screen-Based Antialiasing

### 5.5 Transparency, Alpha, and Compositing

#### 5.5.1 Blend Order

$$
c_0=a_sc_s+(1-a_s)c_d
$$

- $c_s$是透明物体的颜色
- $a_s$物体的透明度
- $c_d$blending前的颜色
- 

###### Order-Independent Transparency

### 5.6 Display Encoding

末读

## Chapter 6 Texturing

（需要重读一遍这一章节）

末读...

### 6.7 Bump Mapping

- 对于凹凸贴图，法线必须相对于某些参照系来改变方向，为此，在每个顶点上存储一个切线坐标系，也称为切线空间基。这个参考系用来把光转换到表面的局部坐标空间

- tangent（切） and bitangent vectors(TBN)表述了normal map在物体空间的坐标轴，如下，由t,b,n三个向量合成的矩阵可将光线从世界空间转到那tangent 空间（物体上某点p的切线空间，该空间的坐标系的底平面与物体表面相切，切点为p），这些向量可能不是相互垂直的（非正交基），然而非正交基可能会导致纹理倾斜，并且需要更多的存储，也会消耗更多性能。如果垂直，该矩阵信息可以只存储tangent和bitangent，通过叉乘计算出法线轴。
  $$
  \left\{
  \begin{matrix}
  t_x&t_y&tz&0\\
  b_x&b_y&b_z&0\\
  n_x&n_y&n_z&0\\
  0&0&0&1
  \end{matrix}
  \right\}\tag{6.13}
  $$
  



- 上面提到如果TBN矩阵的各个向量都是垂直的，可以只保存b和t向量。如果一个模型的所有顶点公用一个TBN矩阵,这样可只将normal向量存储在纹理中（normal纹理）。然而对于对称物体，我们可以只将颜色纹理覆盖对称物体的一半，另一半境像复用。但是对于法线纹理，对称两边的旋向性不同

- Blinn’s Methods

![Sample](.\Imgs\figure6.33.1.png)
![Sample](.\Imgs\figure6.33.2.png)

- Normal Mapping。凸凹映射的一个常见方法是将法线直接存储在贴图上，这种算法和结果在数学上和Blinn‘s methods是等价的，只有存储格式和计算方法有些不同。normal map将（x,y,z）编码转换到[-1,1]，比如用8bit中0表示-1.0，255表示1.0。normal map表示法最初是作为世界空间法线贴图引入的，在实践中很少用。

  

## Chapter 7 Shadows

Real-time Shadows

## Chapter 8 Light and Color

严格来说，RGB代表的是感知量，使用RGB进行基于物理的渲染在技术是错误的，正确的方式是使用光谱量进行所有的渲染计算，然后再转成RGB颜色。

例如：计算物体的反射光线，物体表面通知反射某些波长的光比其它波长的光要多（这可以从它的光谱反射率曲线上看出来），严格正确的计算反射光颜色的方法是将入射光的SPD乘以每个波长的光谱反射率，得到反射光的SPD，然后再将其转货换为RGB颜色。

- **辐射量**的基本单位是辐射通量$Φ$，辐射通量是辐射能量一定时间内流过的能量或单位时间从某一表面发射或到达/通过某一表面的总能量流量，单位为瓦$W$,$1W=1j/s$(焦耳/秒)。

- **辐照度（Irradiance）**是辐射通量相对于面积的密度，如$\frac{d_Φ}{dA}$.辐照度是根据面积来定义的。它的单位为每平方米多少代瓦

- 立体角，是角的三位扩展。角是二维平面上连续方向集合的大小度量，它的值等于这个方向集合与一个半径为1的封闭圆相交的弧的长度（$周长=2\pi r$，如果半径$r=1$,$周长=2\pi=一周的弧度$）。立体角是测量三维宰中连续方向集合的大小，单位为半径为1的封闭球面上相交点的面积定义，坚实的角是由符号$ω$表示。

#### 8.2.1 High Dynamic Range Display Encoding
末读...
## Chapter 9 Physically Based Shading
### 9.1 Physics of Light
光和物质的相互作用形成了基于物理的渲染的基础。在物理学中，光是一种电磁横波，电波和磁波垂直于其传播方向震荡，这两个场的震荡方向是耦合的，磁场矢量和电场矢量相互垂直，它们的长度之比是固定的。

电磁波的波长范围很广，但只有其中很小的一部分(大约400到700纳米)是人类可以看到的。

光波携带能量。能量流的密度等于电场和磁场大小的乘积。我们主要关注电场，因为它对物质的影响比磁场大得多，**在渲染中，我们关注的是平均能量流随时间的变化，它与波的振幅的平方成正比**。这个平均能量流密度是辐照度，用字母e表示。

光波线性结合。总波是各分量波的和。然而，由于辐照度与振幅的平方成正比。对两个相等的波求和有时会导致辐照度出现\1 + 1 = 4"的情况（与波的振幅的平方成正比），但仍然满足能量守恒定律。

大多数情况下，当波相加时，它们是相互不相干的，这意味着它们的相位是相对随机的，在这种情况下，组合波的振幅是$\sqrt{n}$a，**多个波相加时由单个波的辐照度线性增加到n乘以一个波的辐照度**即$n\cdot e$

相长干涉和相消干涉似乎违反了能量守恒定律，当波在空间中传播时，它们之间的相位关系从一个位置变化到另一个位置，某些位置它是相叠，组合波的辐照度大于单个波的辐照度值的总和，在其他地方，它们互相干扰，使组合的辐照度小于单个波辐照度值的和。这并不违反能量守恒定律，因为通过相长干涉得到的能量和通过相消干涉失去的能量总是相互抵消的。

当物体中的电荷发生振荡时，就会发出光波。一部分引起振荡的能量，热量，电能，化学能，被转换成光能，从物体辐射出去。在渲染中，这些对象被当作光源。

光波发出后，它们在空间中传播，直到遇到一些可以相互作用的物质。大多数光与物质相互作用的核心现象很简单，与上面讨论的发射情况非常相似。振荡的电场推动和拉动物质中的电荷，使它们依次振荡。振荡的电荷释放出新的光波，将部分入射光波的能量重新定向到新的方向。这种被称为散射的反应是各种光学现象的基础

**散射光波的频率与原始光波相同**。通常情况下，当原始波包含多种频率的光时，每一种都单独与物质相互作用。以一个频率入射的光能不会导致以不同频率发射的光能，除了特殊的和相对罕见的情况

反射光和折射光的比例由菲涅耳方程描述

#### BRDF 

**双向反射分布函数BRDF（Bidirectional Reflectance Distribution Function）**定量描述述了物体表面一点是如何和光进行交互的。大多数情况下，BRDF 可以用 $f (l, v)$来表示，其中 $l$为入射方向和$v$为观察方向（双向的含义）。这种情况下，绕着表面法线旋转入射方向或观察方向并不会影响BRDF的结果，这种 BRDF 被称为是各项同性（isotropic）的BRDF。与之对应的则是各向异性（anisotropic）的BRDF。

BRDF有两种理解方式：

- 第一种理解是，当给定 入射角度后，BRDF 可以给出所有出射方向上的反射和散射光线的相对分布情况；
- 第二种理解是，当给定观察方向（即出射方向）后，BRDF 可以给出从所有入射方向到该出射方向的光线分布。一个更直观的理解是，当一束光线沿着入射方向$l$ 到达表面某点时，$f (l, v)$表示了有多少部分的能量被反射到了观察方向$v$上。

对于一个方向的入射光，表面会将光反射到表面上半球的各个方向，不同方向反射的比例是不同的，我们用BRDF来表示指定方向的反射光和入射光的比例关系，BRDF定义为：
$$
f(l,v)=\frac{dL_0(v)}{dE(l)}
$$
- BRDF是一个光谱量。理论上，输入和输出的波长将是额外的BRDF输入，大大增加了它的维数。然而，在实际操作中，不同波长之间不存在串扰，因此每一波长的输出光只会受到入射光中相同波长的影响。这意味着，我们(更简单地)不是将输入和输出波长作为BRDF的输入来处理，而是将BRDF作为一个与一个频谱值的颜色相乘的频谱值函数。在生产阴影中，这意味着rgb值的BRDF乘以rgb值的光颜色。
- 其中$f$就是BRDF，$l$是入射光方向，$v$是观察方向。
- $dL_0(v)$是表面反射到$v$方向的反射光的微分辐射率。表面反射到$v$方向的反射光的辐射率为$L_0(v)$，来自于表面上半球所有方向的入射光线的贡献，而微分辐射率$dL_0(v)$特指来自方向$l$的入射光贡献的反射辐射率。
- $dE(l)$是表面上来入射光方向$l$的微分辐照度。表面接收到的辐照度为$E$,来自上半球所有方向的入射光线的贡献，而微分辐照度$eE(l)$特指来自于方向$l$的入射光。
- 表面对不同频率的光反射率可能不一样，因此BRDF和光的频率有关。在图形学中，将BRDF表示为RGB向量，三个分量各有自己的$f$函数。

#### 微表面理论

微表面理论（Microfacet Theory）认为我们看到的表面上的一点是由很多朝向各异且光学平的微小表面组成。当光线从$l$方向照射到这点，而我们在$v$方向观察时，由于光学平面只会将光线$l$反射到关于法线对称的方$v$向，而和$l$和$v$已经确定，所以**只有法线朝向正好是$l$和$v$的半角向量$h$的微表面才会将光线发射到$v$方向*（*如下图），从而被我们看见。

![](.\Imgs\microfacet.jpg)
我们用**法线分布函数**（Normal Distribution Function，简写为NDF）**$D(h)$来描述组成表面一点的所有微表面的法线分布概率**，现在可以这样理解：向NDF输入一个朝向$h$，NDF会返回朝向是$h$的微表面数占微表面总数的比例（虽然实际并不是这样，这点我们在讲推导过程的时候再讲），比如有1%的微表面朝向是$h$，那么就有1%的微表面可能将光线反射到$v$方向。

但实际上并不是所有微表面都能收到接受到光线，如下面左边的图有一部分入射光线被遮挡住，这种现象称为Shadowing。也不是所有反射光线都能到达眼睛，下面中间的图，一部分反射光线被遮挡住了，这种现象称为Masking。光线在微表面之间还会互相反射，如下面右边的图，这可能也是一部分漫射光的来源，在建模高光时忽略掉这部分光线。如下图：

![](.\Imgs\microfacet_shadowing_masking.jpg)

Shadowing和Masking用**几何衰减因子（Geometrical Attenuation Factor）**$G(l, v)$来建模，输入入射和出射光线方向，输出值表示光线未被遮蔽而能从$l$反射到方向$v$的比例。

光学平面并不会将所有光线都反射掉，而是一部分被反射，一部分被折射，反射比例符合**菲涅尔方程（Fresnel Equations）**$F(l,h)$

Torrance-Sparrow基于微表面理论，用上述三个函数建立了高光BRDF模型：
$$
f(l,v)=\frac{F(l,h)G(l,h)D(h)}{4cos\theta_icos\theta_o}=\frac{F(l,h)G(l,h)D(h)}{4(n\cdot l)(n\cdot v)}
$$

其中$n$是宏观表面法线，$h$是微表面法线

这个模型后来由Cook-Torrance引入计算机图形学，也被称为Cook-Torrance模型。不过Cook-Torrance的论文里上式分母里的系数由4改成了$\pi$，但现在大家公认应该用4，下面我们来看看这个公式的推导过程。

## Cook-Torrance模型公式推导

渲染方程式：
$$
L_o(v) = L_e+\int_{\Omega}f(\omega_i,v)L_i(w_i)(n\cdot\omega_i)d\omega_i
$$
即给定观察视角 v，该方向上的出射辐射率 $L_o(v)$等于该点向观察方向发出的自发光辐射率$ L_e(v)$加上所有有效的入射光$L_i(ω_i)$到达观察点的辐 射率积分和

![](.\Imgs\brdf_.png)

渲染方程是计算机图形学的核心公式，当去掉其中的自发光项$L_e(v)$后，剩余的部分就是著名 的**反射等式（Reflectance Equation）**。我们可以这样理解反射等式：想象我们现在要计算表面上某 点的出射辐射率，我们已知到该点的观察方向，该点的出射辐射率是由从许多不同方向的入射辐 射率叠加后的结果。其中，$f (\omega_i, v)$表示了不同方向的入射光在该观察方向上的权重分布。我们把 这些不同方向的光辐射率（$L_i(\omega_i)$部分）乘以观察方向上所占的权重（$f (\omega_i, v)$部分），再乘以它们 在该表面的投影结果（$(n\cdot\omega_i)$部分），最后再把这些值加起来（即做积分）就是最后的出射辐射率。

在实时渲染中，自发光项通常就是直接加上某个自发光值。除此之外，积分累加部分在实时 渲染中也基本无法实现，因此积分部分通常会被若干精确光源的叠加所代替，而不需要计算所有 入射光线在半球面上的积分。

BRDF决定了着色过程是否是基于物理的。这可以由BRDF是否满足两个特性来判断：它是否满足**交换律（reciprocity）**和**能量守恒（energy conservation）**。

- 交换律要求当交换$l$ 和$v$的值后，BRDF的值不变，即：$f(l,v)=f(v,l)$

- 能量守恒则要求表面反射的能量不能超过入射的光能，即：


基于这些理论，BRDF 可以用于描述两种不同的物理现象：表面反射和次表面散射。针对每种现象，BRDF通常会包含一个单独的部分来描述它们—用于描述表面反射的部分被称为高光反射项（specular term），以及用于描述次表面散射的漫反射项（diffuse term），如图所示:

![](.\Imgs\brdf_spec&diffuse.png)

<center>BRDF描述的两种现象。高光反射部分和漫反射部分</center>

#### 漫反射项和高光反射项的一些常见的**BRDF**数学模型：

##### 漫反射项：

1. Lambert模型。Lambert模型就是最简单、也是应用最广泛的漫反射BRDF。准确的Lambertian BRDF的表示为：$f_{Lambert}(l,v)=\frac{c_{diff}}{\pi}$,$c_{diff}$表示漫反射光线所占的比例，它也通常被称为是漫反射颜色（diffuse color）。之所以要除 以$\pi$，是因为我们假设漫反射在所有方向上的强度都是相同的，而BRDF 要求在半球内的积分值 为 1。
2. Disney BRDF中的漫反射项为：  
$$
f_{diff}(l,v)=\frac{baseColor}{\pi}(1+(F_{D90}-1)(1-n\cdot l)^5)(1+(F_{D90}-1)(1-n\cdot v)^5)
$$
- 其中，$F_{D90}=0.5+2roughness(h\cdot l)^2$
- $baseColor$是表面颜色，通常由纹理采样得到。
- $roughness$是表面的粗糙度。
- 这个公式也是Unity5内部使用的漫反射项。

##### 高光反射项：

在基于物理的渲染中，BDRF 中的高光反射项大多数都是建立在**微面元理论（microfacet theory）**的假设上的。计算BRDF 时，入射方向$l$和观察方向$v$都会被给定。

- 不同的微面元会把同一入射 方向的光线反射到不同的方向上，这意味着只有一部分微面元反射的光线才会进入到我们的眼睛中，这部分微面元会恰好把光线反射到方向$v$上，即它们的法线$m$等于$l$和$v$的一半，也就是我们一直看到的半角度矢量$h$(half angle vector)
- 然而，这些$m = h$的微面元反射也并不会全部反射到人眼中。这是因为，它们其中一部分会在入射方向$l$上被其他微面元挡住（shadowing），或是在它们的反射方向$v$上被其他微面元挡住了(masking)。

基于微面元理论的这些假设，BRDF的高光反射项可以用下面的通用形式来表示：
$$
f_{spec(l,v)}=\frac{F(l,v)G(l,v,h)D(h)}{4(n\cdot l)(n\cdot v)}
$$

- $D(h)$是微面元的**法线分布函数(normal distribution function，NDF)**，用于计算有多少比例的微面元的法 线满足$m=h$，只有这部分微面元才会把光线从$l$方向反射到$v$上。
- $G(l,v,h)$是**阴影遮掩函数（shadowing-masking function）**。用于计算那些满足$m=h$的微面元中有多少会由于遮挡而不会 被人眼看到，因此它给出了活跃的微面元（active microfacets）所占的浓度，只有活跃的微面元才 会成功地把光线反射到观察方向上

- $F(l,h)$则是这些活跃微面元的**菲涅尔反射（Fresnel reflectance）**函数。计量们每个活跃的微面元会把多少入射光线反射到观察方向上，即表示了反射光线占入射光线的比率（反射率）
- 分母$4(n\cdot l)(n\cdot v)$用于校正从微面元的局部空间到整体宏观表面数量差异的校正因子。

###### 菲涅耳反射函数

菲涅耳反射函数计算了光学表面反射光线所占的部分，它表明了当光照方向和观察方向夹角逐渐增大时高光反射强度增大的现象。完整的菲涅耳等式非常复杂，包含了诸如复杂的折射率等与材质相关的参数。为了给美术人员提供更加直观且方便调节的参数，大多数PBS实现选择使用Schlick菲涅耳近似等式来得到近似的菲涅尔反射效果：
$$
F_{Schlick}(l,h)=c_{spec}+(1-c_{spec})(1-(l\cdot h))^5
$$
其中，$c_{spec}$ 是材质的高光反射颜色。通过对真实世界材质的观察，人们发现金属材质的高光 反射颜色值往往比较大，而非金属材质的反射颜色值则往往较小。

###### 法线分布函数

法线分布函数$D(h)$表示了对于当前表面来说有多少比例的微面元的法线满足$m=h$，这意味着 只有这些微面元才会把光线从$l$方向反射到$v$上。对于大多数表面来说，微面元的法线朝向并不是均匀分布的，更多的微面元会具有和表面法线$n$相同的面法线。**法线分布函数的值必须是非负的标量值，它决定了高光区域的大小、亮度和形状，因此是高光反射项中非常重要的一项**。当表面的粗糙度下降时，应该有更多的微面元的面法线满足$m=n$。，因此法线分布函数应该考虑到表面粗糙度的影响。

**Blinn-Phong 模型 使用的法线分布函数$D(h)$**为：
$$
D_{blinn}(h)=\frac{gloss+2}{2\pi}(n\cdot h)^{gloss}
$$

- $gloss$是与表面粗糙度相关的参数，可以是任意的非负数

